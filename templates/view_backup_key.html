{% extends "base.html" %}

{% block title %}Backup Key - Spectre{% endblock %}
{% block page_title %}
    {% if is_admin_view %}
    Backup Key for {{ user.username }}
    {% else %}
    Backup Key
    {% endif %}
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0">
                    <i class="bi bi-shield-lock-fill"></i> Backup Key (AES-256)
                    {% if is_admin_view %}
                    - {{ user.username }}
                    {% endif %}
                </h5>
            </div>
            <div class="card-body">
                <div class="alert alert-success">
                    <i class="bi bi-check-circle-fill"></i>
                    <strong>Verification successful!</strong> Valid OTP code.
                </div>

                <div class="card bg-dark mb-4">
                    <div class="card-body">
                        <h6 class="text-light mb-3">
                            <i class="bi bi-lock-fill"></i> BACKUP_PASSWORD
                        </h6>
                        <div class="input-group input-group-lg">
                            <span class="input-group-text bg-secondary text-white">
                                <i class="bi bi-shield-lock-fill"></i>
                            </span>
                            <input type="text"
                                   class="form-control bg-dark text-white"
                                   id="backupKeyField"
                                   value="{{ backup_key }}"
                                   readonly
                                   style="font-family: monospace; font-size: 1.1rem; letter-spacing: 0.05em; border-color: #495057;">
                            <button class="btn btn-secondary" type="button" onclick="copyBackupKey()" title="Copy Backup Key">
                                <i class="bi bi-clipboard" id="copyIcon"></i> Copy
                            </button>
                        </div>
                    </div>
                </div>

                <div class="alert alert-danger">
                    <h6><i class="bi bi-exclamation-triangle-fill"></i> <strong>CRITICAL INSTRUCTIONS</strong></h6>
                    <ol class="mb-0">
                        <li><strong>Copy this key</strong> and store it in a secure password vault (e.g., Bitwarden, 1Password, KeePass)</li>
                        <li><strong>NEVER share</strong> this key via email, chat, or messaging</li>
                        <li><strong>Without this key, backups cannot be restored</strong></li>
                        <li>If you lose this key, you will need to <strong>recreate all backups</strong></li>
                        {% if is_admin_view %}
                        <li>This viewing was <strong>logged in the audit logs</strong></li>
                        {% endif %}
                    </ol>
                </div>

                <div class="card border-secondary">
                    <div class="card-header bg-secondary text-white">
                        <i class="bi bi-info-circle-fill"></i> How to Use the Backup Key
                    </div>
                    <div class="card-body">
                        <p><strong>This key is required to:</strong></p>
                        <ul class="mb-0">
                            <li>Decrypt downloaded backups</li>
                            <li>Restore backups to the original server</li>
                            <li>Access files within backup archives</li>
                        </ul>
                        <p class="mt-3 mb-0">
                            <i class="bi bi-shield-check"></i>
                            All backups are encrypted with <strong>AES-256</strong> using this key.
                        </p>
                    </div>
                </div>

                <div class="mt-4 text-center">
                    <a href="{% if is_admin_view %}{{ url_for('users.users') }}{% else %}{{ url_for('main.index') }}{% endif %}" class="btn btn-primary btn-lg">
                        <i class="bi bi-check-circle"></i> Done
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function copyBackupKey() {
    const keyField = document.getElementById('backupKeyField');
    const copyIcon = document.getElementById('copyIcon');

    // Copy to clipboard
    keyField.select();
    keyField.setSelectionRange(0, 99999);

    navigator.clipboard.writeText(keyField.value).then(function() {
        // Visual feedback
        copyIcon.classList.remove('bi-clipboard');
        copyIcon.classList.add('bi-clipboard-check');

        // Show success message
        const btn = copyIcon.parentElement;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-check-circle-fill"></i> Copied!';
        btn.classList.remove('btn-secondary');
        btn.classList.add('btn-success');

        // Restore after 3 seconds
        setTimeout(function() {
            btn.innerHTML = originalText;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-secondary');
            copyIcon.classList.remove('bi-clipboard-check');
            copyIcon.classList.add('bi-clipboard');
        }, 3000);
    }).catch(function(err) {
        // Fallback for older browsers
        document.execCommand('copy');
        alert('Backup Key copied to clipboard!');
    });
}
</script>
{% endblock %}
