{% extends "base.html" %}

{% block title %}Configure 2FA - Spectre{% endblock %}
{% block page_title %}Two-Factor Authentication - {{ user.username }}{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-shield-lock"></i> 2FA Setup - {{ user.username }}</span>
                <a href="{% if current_user.is_admin() and current_user.id != user.id %}{{ url_for('users.users') }}{% else %}{{ url_for('main.index') }}{% endif %}" class="btn btn-secondary btn-sm">
                    <i class="bi bi-arrow-left"></i> Back
                </a>
            </div>
            <div class="card-body">
                {% if otp_enabled %}
                <div class="alert alert-success">
                    <i class="bi bi-check-circle"></i>
                    <strong>2FA Enabled!</strong> Your account is protected with two-factor authentication.
                </div>

                <div class="alert alert-warning">
                    <i class="bi bi-lock-fill"></i>
                    <strong>Security:</strong> Once enabled, 2FA cannot be reconfigured for this user.
                    To use a new device, you will need to create a new user account.
                </div>

                <div class="card bg-light">
                    <div class="card-body">
                        <h6><i class="bi bi-info-circle"></i> 2FA is active</h6>
                        <p class="text-muted mb-0">
                            Two-factor authentication is configured and cannot be changed for security reasons.
                            If you have lost access to your 2FA device, please contact the system administrator.
                        </p>
                    </div>
                </div>

                <div class="mt-3">
                    <a href="{% if current_user.is_admin() and current_user.id != user.id %}{{ url_for('users.users') }}{% else %}{{ url_for('main.index') }}{% endif %}" class="btn btn-secondary">
                        <i class="bi bi-arrow-left"></i> Back
                    </a>
                </div>

                {% else %}
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>2FA Disabled!</strong> We recommend enabling two-factor authentication for enhanced security.
                </div>

                <h5 class="mb-3">How to set up:</h5>
                <ol>
                    <li>Install an authenticator app on your phone (Google Authenticator, Microsoft Authenticator, Authy, etc.)</li>
                    <li>Scan the QR code below with the app</li>
                    <li>Or manually enter the secret key</li>
                    <li>Enter the 6-digit code generated by the app to activate</li>
                </ol>

                <div class="row mt-4">
                    <div class="col-md-6 text-center">
                        <h6>QR Code</h6>
                        <img src="data:image/png;base64,{{ qr_code }}"
                             alt="QR Code"
                             class="img-fluid border p-3 bg-white"
                             style="max-width: 300px;">
                    </div>
                    <div class="col-md-6">
                        <h6>Secret Key</h6>
                        <div class="alert alert-info">
                            <code style="font-size: 1.1rem; word-break: break-all;">{{ secret }}</code>
                        </div>
                        <p class="text-muted small">
                            <i class="bi bi-info-circle"></i>
                            Save this key in a secure location. You can use it to restore access if you lose your phone.
                        </p>
                    </div>
                </div>

                <hr class="my-4">

                <h5 class="mb-3">Enable 2FA for {{ user.username }}</h5>
                <form method="POST" action="{{ url_for('users.enable_2fa_user', user_id=user.id) }}">
                    <div class="mb-3">
                        <label for="otp_code" class="form-label">OTP Code (6 digits)</label>
                        <input type="text"
                               class="form-control"
                               id="otp_code"
                               name="otp_code"
                               maxlength="6"
                               pattern="[0-9]{6}"
                               placeholder="000000"
                               required>
                        <div class="form-text">
                            Enter the code generated by the authenticator app
                        </div>
                    </div>

                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-check-circle"></i> Enable 2FA
                    </button>
                    <a href="{% if current_user.is_admin() and current_user.id != user.id %}{{ url_for('users.users') }}{% else %}{{ url_for('main.index') }}{% endif %}" class="btn btn-secondary">
                        <i class="bi bi-arrow-left"></i> Back
                    </a>
                </form>
                {% endif %}
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <i class="bi bi-info-circle"></i> Security Information
            </div>
            <div class="card-body">
                <h6>What is 2FA?</h6>
                <p class="text-muted mb-3">
                    Two-Factor Authentication (2FA) adds an extra layer of security to your account.
                    In addition to your password, you will need a temporary code generated by the authenticator app on your phone.
                </p>

                <h6>Recommended apps:</h6>
                <ul class="text-muted">
                    <li><strong>Google Authenticator</strong> - iOS and Android</li>
                    <li><strong>Microsoft Authenticator</strong> - iOS and Android</li>
                    <li><strong>Authy</strong> - iOS, Android and Desktop</li>
                    <li><strong>1Password</strong> - Multi-platform (paid)</li>
                </ul>

                <div class="alert alert-info mb-0">
                    <i class="bi bi-shield-check"></i>
                    <strong>Tip:</strong> Save the secret key in a secure location (password vault, paper in a safe place)
                    so you can restore access if you lose your phone.
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Allow only numbers in OTP input
document.getElementById('otp_code')?.addEventListener('input', function(e) {
    this.value = this.value.replace(/[^0-9]/g, '');
});
</script>
{% endblock %}
